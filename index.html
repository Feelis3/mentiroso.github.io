<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>MENTIROSO - Online</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Archivo+Black&family=Inter:wght@400;900&display=swap");
      :root {
        --pink: #db2777;
      }
      body {
        background-color: #000;
        color: #fff;
        font-family: "Inter", sans-serif;
        margin: 0;
        overflow: hidden;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
      }
      section {
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: sticky;
        top: 0;
        background: #050505;
        padding: 1.5rem;
      }
      .hero-title {
        font-family: "Archivo Black", sans-serif;
        font-size: clamp(2rem, 8vw, 5rem);
        line-height: 0.85;
        text-align: center;
        text-transform: uppercase;
        background: linear-gradient(to bottom, #fff, #444);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .custom-input {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 0.8rem;
        border-radius: 12px;
        width: 100%;
        max-width: 320px;
        text-align: center;
        font-weight: 700;
        color: white;
        margin-bottom: 0.5rem;
        outline: none;
      }
      .btn-action {
        background: #fff;
        color: #000;
        font-weight: 900;
        padding: 1rem;
        text-transform: uppercase;
        width: 100%;
        max-width: 320px;
        border-radius: 12px;
        transition: 0.3s;
        border: none;
        cursor: pointer;
      }
      .player-card {
        position: relative;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 0.6rem;
        border-radius: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
      }
      .avatar {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: #1a1a1a;
        border: 2px solid var(--pink);
      }
      .status-badge {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-left: auto;
      }
      .blur-content {
        filter: blur(25px);
        opacity: 0;
        transition: 0.3s;
        pointer-events: none;
      }
      .show-content {
        filter: blur(0);
        opacity: 1;
      }
      .hidden {
        display: none !important;
      }
      .btn-back {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 100;
        background: rgba(255, 255, 255, 0.1);
        padding: 8px 12px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 900;
        text-transform: uppercase;
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
      }
      .kick-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #ff4444;
        color: white;
        font-size: 10px;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        cursor: pointer;
        z-index: 10;
      }

      #reaction-container {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 1000;
      }
      .reaction-pop {
        position: absolute;
        left: 50%;
        bottom: 20%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        animation: reactionFloat 2.5s ease-out forwards;
      }
      @keyframes reactionFloat {
        0% {
          transform: translate(-50%, 0);
          opacity: 0;
          scale: 0.5;
        }
        15% {
          transform: translate(-50%, -20px);
          opacity: 1;
          scale: 1.2;
        }
        100% {
          transform: translate(-50%, -100px);
          opacity: 0;
          scale: 1;
        }
      }
      #reaction-menu {
        position: fixed;
        bottom: 85px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 200;
        transition: 0.3s transform, 0.3s opacity;
        transform: scale(0);
        opacity: 0;
        transform-origin: bottom right;
      }
      #reaction-menu.open {
        transform: scale(1);
        opacity: 1;
      }
      .reaction-btn {
        width: 45px;
        height: 45px;
        background: #1a1a1a;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        cursor: pointer;
      }
      #trigger-reaction {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 55px;
        height: 55px;
        background: var(--pink);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        z-index: 201;
        cursor: pointer;
        box-shadow: 0 10px 20px rgba(219, 39, 119, 0.3);
      }

      #ejection-screen {
        position: fixed;
        inset: 0;
        background: #000;
        z-index: 500;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: 0.5s opacity;
        overflow: hidden;
      }
      #ejection-screen.active {
        opacity: 1;
        pointer-events: auto;
      }
      .ejection-text {
        font-family: "Archivo Black", sans-serif;
        font-size: 1.5rem;
        text-align: center;
        color: #fff;
        max-width: 85%;
        margin-top: 3rem;
        text-transform: uppercase;
      }
      .floating-avatar {
        width: 100px;
        height: 100px;
        animation: floatX 4.5s infinite linear;
        position: absolute;
        left: -150px;
      }
      @keyframes floatX {
        0% {
          transform: translateX(-150vw) rotate(0deg);
        }
        100% {
          transform: translateX(250vw) rotate(1000deg);
        }
      }
    </style>
  </head>
  <body>
    <button id="btn-logout" onclick="logout()" class="btn-back hidden">
      ‚Üê Salir
    </button>
    <div id="reaction-container"></div>
    <div id="reaction-menu">
      <button onclick="sendReaction('ü¶ê')" class="reaction-btn">ü¶ê</button>
      <button onclick="sendReaction('ü§´')" class="reaction-btn">ü§´</button>
      <button onclick="sendReaction('üßê')" class="reaction-btn">üßê</button>
      <button onclick="sendReaction('üòÖ')" class="reaction-btn">üòÖ</button>
      <button onclick="sendReaction('üî•')" class="reaction-btn">üî•</button>
    </div>
    <div
      id="trigger-reaction"
      class="hidden"
      onclick="document.getElementById('reaction-menu').classList.toggle('open')"
    >
      üí¨
    </div>
    <div id="ejection-screen">
      <div
        id="ejection-avatars-flow"
        class="w-full h-32 relative flex items-center"
      ></div>
      <p id="ejection-msg" class="ejection-text"></p>
    </div>

    <div class="stack-container">
      <section id="screen-lobby">
        <h1 class="hero-title">MENTI<br />ROSO</h1>
        <div class="text-6xl my-4 animate-bounce text-center">ü¶ê</div>
        <input
          type="text"
          id="username"
          class="custom-input"
          placeholder="TU NOMBRE..."
        />
        <div id="lobby-main" class="flex flex-col gap-3 w-full items-center">
          <button
            onclick="showCreateOptions()"
            class="btn-action !bg-pink-600 !text-white text-xs"
          >
            CREAR SALA ONLINE
          </button>
          <div class="flex gap-2 w-full max-w-[320px]">
            <input
              type="text"
              id="roomInput"
              class="custom-input !mb-0"
              placeholder="C√ìDIGO"
            />
            <button
              onclick="joinRoom()"
              class="bg-zinc-800 px-6 rounded-xl font-black uppercase text-xs text-white"
            >
              Unirse
            </button>
          </div>
        </div>
        <div
          id="create-options"
          class="hidden flex flex-col gap-2 w-full items-center bg-zinc-900/50 p-6 rounded-3xl border border-white/10"
        >
          <button
            onclick="finalizeCreation('admin')"
            class="btn-action !py-3 text-xs"
          >
            Modo Admin
          </button>
          <button
            onclick="finalizeCreation('normal')"
            class="btn-action !py-3 text-xs"
          >
            Modo Normal
          </button>
          <button
            onclick="finalizeCreation('ideas')"
            class="btn-action !py-3 text-xs"
          >
            Modo Ideas
          </button>
          <button
            onclick="showCreateOptions(false)"
            class="text-[10px] uppercase font-bold opacity-50 mt-2 text-white text-center"
          >
            Cancelar
          </button>
        </div>
      </section>

      <section id="screen-room" class="hidden">
        <div class="text-center w-full max-w-lg px-4">
          <div
            id="mode-tag"
            class="inline-block bg-pink-600 text-white text-[8px] font-black uppercase px-3 py-1 rounded-full mb-2 tracking-widest text-center"
          >
            ---
          </div>
          <h2
            id="room-code-display"
            class="hero-title !text-[3.5rem] mb-2 text-white text-center"
          >
            ----
          </h2>
          <button
            id="whatsapp-btn"
            onclick="shareWhatsApp()"
            class="bg-green-600 text-[10px] font-black py-2 px-4 rounded-full mb-4 uppercase flex items-center gap-2 mx-auto"
          >
            Invitar Amigos üì≤
          </button>

          <div
            id="ideas-input-box"
            class="hidden bg-zinc-900 border border-pink-600/50 p-5 rounded-2xl mb-6 shadow-2xl"
          >
            <p
              class="text-[10px] font-black uppercase text-pink-500 mb-3 tracking-widest"
            >
              Tu aporte para la ronda
            </p>
            <input
              type="text"
              id="idea-word"
              class="custom-input !text-xs !py-3"
              placeholder="Palabra secreta"
            />
            <input
              type="text"
              id="idea-cat"
              class="custom-input !text-xs !py-3"
              placeholder="Categor√≠a"
            />
            <button
              id="btn-send-idea"
              onclick="sendIdea()"
              class="btn-action !bg-pink-600 !text-white !py-3 text-xs uppercase"
            >
              Enviar Idea
            </button>
          </div>

          <div
            id="player-list"
            class="grid grid-cols-2 gap-2 mt-6 mb-6 max-h-[35vh] overflow-y-auto"
          ></div>

          <div
            id="host-controls"
            class="hidden bg-zinc-900 p-6 rounded-3xl border border-white/10 w-full max-w-[320px] mx-auto text-center"
          >
            <div
              id="manual-input-admin"
              class="hidden mb-4 border-b border-white/5 pb-4"
            >
              <input
                type="text"
                id="admin-manual-word"
                class="custom-input !text-xs"
                placeholder="Palabra Secreta..."
              />
            </div>
            <div class="mb-4">
              <label
                class="text-[10px] font-black uppercase block mb-1 text-zinc-500"
                >Mentirosos:
                <span id="liar-count-val-online" class="text-pink-500 font-bold"
                  >1</span
                ></label
              >
              <input
                type="range"
                id="liar-range"
                min="1"
                max="3"
                value="1"
                oninput="document.getElementById('liar-count-val-online').innerText = this.value"
              />
            </div>
            <p
              id="ideas-status"
              class="text-[8px] font-black text-zinc-500 mb-2"
            ></p>
            <button
              onclick="startGame()"
              id="btn-start-game"
              class="btn-action !bg-white !text-black text-xs"
            >
              INICIAR RONDA
            </button>
          </div>
          <p
            id="wait-msg"
            class="text-zinc-500 font-bold uppercase text-[9px] tracking-widest animate-pulse mt-4 text-center"
          >
            Esperando jugadores...
          </p>
        </div>
      </section>

      <section id="screen-game-order" class="hidden text-center">
        <h2
          class="hero-title !text-[3rem] mb-6 text-white text-center text-center"
        >
          TURNO
        </h2>
        <div
          id="turn-order-list"
          class="flex flex-col gap-3 w-full max-w-sm px-4 mx-auto text-white"
        ></div>
        <button
          id="host-start-trigger"
          onclick="confirmStartGame()"
          class="btn-action !bg-pink-600 !text-white mt-8 hidden"
        >
          VER ROLES
        </button>
      </section>

      <section id="screen-game" class="hidden">
        <div id="admin-view" class="hidden text-center">
          <div
            class="bg-zinc-900 p-8 rounded-[2.5rem] border border-white/10 mb-6"
          >
            <p class="text-zinc-500 text-[10px] font-bold uppercase mb-2">
              MODO ADMIN - PALABRA:
            </p>
            <p
              id="admin-word-info"
              class="text-4xl font-black text-white uppercase text-center"
            ></p>
          </div>
        </div>
        <div
          id="player-view"
          class="border-2 border-white/10 p-8 text-center w-full max-w-sm rounded-[2.5rem] bg-zinc-900/50 mx-auto"
        >
          <div id="blur-wrapper" class="blur-content">
            <h2
              id="role-title"
              class="text-5xl font-black uppercase mb-8 text-center"
            >
              ...
            </h2>
            <div
              id="word-display"
              class="font-black text-4xl tracking-tighter text-yellow-400 mb-4 uppercase text-center"
            >
              ---
            </div>
            <p
              id="hint-text"
              class="text-zinc-400 text-xs font-bold uppercase border-t border-white/5 pt-4 text-center"
            ></p>
          </div>
          <button
            onmousedown="toggleReveal(true)"
            onmouseup="toggleReveal(false)"
            ontouchstart="toggleReveal(true)"
            ontouchend="toggleReveal(false)"
            class="btn-reveal mt-8 bg-white text-black text-[11px] font-black py-5 px-10 rounded-2xl w-full uppercase text-center"
          >
            MANT√âN PARA VER
          </button>
        </div>
        <div
          id="host-game-controls"
          class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 w-[90%] max-w-[320px] z-[100]"
        >
          <button
            onclick="openVoting()"
            class="btn-action !bg-pink-600 !text-white shadow-2xl"
          >
            ABRIR VOTACI√ìN
          </button>
        </div>
      </section>

      <section id="screen-voting" class="hidden text-center">
        <h2 class="hero-title !text-[3rem] mb-6 text-white text-center">
          ¬øQUI√âN ES?
        </h2>
        <div
          id="vote-list"
          class="flex flex-col gap-3 w-full max-w-sm px-4 mx-auto text-white"
        ></div>
        <div
          id="vote-results"
          class="hidden w-full max-w-sm px-4 mt-6 bg-zinc-900/80 p-6 rounded-3xl border border-white/10 text-center mx-auto text-white"
        >
          <div
            id="results-display"
            class="flex flex-col gap-2 mb-6 text-white text-xs"
          ></div>
          <button
            id="btn-final-reset"
            onclick="resetGame()"
            class="btn-action !bg-white !text-black mt-6 text-xs hidden uppercase"
          >
            Nueva Ronda
          </button>
        </div>
      </section>
    </div>

    <script>
      var currentRoom = null,
        myName = "",
        db = null,
        myVotes = [],
        animShowed = false;
      const firebaseConfig = {
        apiKey: "AIzaSyCRoM4Fuz5eGGnXSwNYRn-nf8oII_ulLuQ",
        authDomain: "mentiroso-marcos-perez.firebaseapp.com",
        databaseURL:
          "https://mentiroso-marcos-perez-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "mentiroso-marcos-perez",
        storageBucket: "mentiroso-marcos-perez.firebasestorage.app",
        messagingSenderId: "968925541268",
        appId: "1:968925541268:web:97a255db8eeff952b71581",
      };
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      function shuffleArray(a) {
        for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
      }
      const getAvatar = (n) =>
        `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(n)}`;

      window.onload = () => {
        const params = new URLSearchParams(window.location.search);
        if (params.get("join"))
          document.getElementById("roomInput").value = params
            .get("join")
            .toUpperCase();
        const sR = localStorage.getItem("mentiroso_room"),
          sN = localStorage.getItem("mentiroso_name");
        if (sR && sN) {
          db.ref("rooms/" + sR).once("value", (s) => {
            if (s.exists()) {
              myName = sN;
              currentRoom = sR;
              listenToRoom(sR);
            } else logout();
          });
        } else
          document.getElementById("screen-lobby").classList.remove("hidden");
      };

      function logout() {
        localStorage.clear();
        location.reload();
      }
      function showCreateOptions(s = true) {
        document.getElementById("lobby-main").classList.toggle("hidden", s);
        document
          .getElementById("create-options")
          .classList.toggle("hidden", !s);
      }
      function toggleReveal(s) {
        document.getElementById("blur-wrapper").className = s
          ? "show-content"
          : "blur-content";
      }
      function kickPlayer(p) {
        if (confirm(`¬øExpulsar a ${p}?`))
          db.ref(`rooms/${currentRoom}/players/${p}`).set("KICKED");
      }
      function shareWhatsApp() {
        const text = `¬°√önete a MENTIROSO! ü¶ê\nLink: ${window.location.origin}${window.location.pathname}?join=${currentRoom}`;
        window.open(
          `https://wa.me/?text=${encodeURIComponent(text)}`,
          "_blank"
        );
      }
      function sendReaction(emoji) {
        if (!currentRoom) return;
        db.ref(`rooms/${currentRoom}/lastReaction`).set({
          user: myName,
          emoji,
          time: Date.now(),
        });
      }

      function sendIdea() {
        const w = document
            .getElementById("idea-word")
            .value.trim()
            .toUpperCase(),
          c = document.getElementById("idea-cat").value.trim().toUpperCase();
        if (!w || !c) return alert("Rellena ambos campos");
        // Bloqueo preventivo visual local
        document.getElementById("btn-send-idea").disabled = true;
        document.getElementById("btn-send-idea").innerText = "...";
        db.ref(`rooms/${currentRoom}/ideas/${myName}`).set({ w, c });
      }

      function finalizeCreation(m) {
        let n = document.getElementById("username").value.trim().toUpperCase();
        if (!n) return alert("Nombre...");
        const c = Math.random().toString(36).substring(2, 6).toUpperCase();
        myName = n;
        currentRoom = c;
        const p = m === "admin" ? {} : { [n]: true };
        db.ref("rooms/" + c)
          .set({
            host: n,
            status: "waiting",
            mode: m,
            players: p,
            points: { [n]: 0 },
          })
          .then(() => {
            localStorage.setItem("mentiroso_room", c);
            localStorage.setItem("mentiroso_name", n);
            listenToRoom(c);
          });
      }

      function joinRoom() {
        let n = document.getElementById("username").value.trim().toUpperCase();
        const c = document
          .getElementById("roomInput")
          .value.trim()
          .toUpperCase();
        if (!c || !n) return alert("Faltan datos");
        db.ref("rooms/" + c).once("value", (s) => {
          if (!s.exists()) return alert("No existe");
          myName = n;
          currentRoom = c;
          localStorage.setItem("mentiroso_room", c);
          localStorage.setItem("mentiroso_name", n);
          db.ref(`rooms/${c}/players/${n}`).set(true);
          db.ref(`rooms/${c}/points/${n}`).transaction((p) => p || 0);
          listenToRoom(c);
        });
      }

      function listenToRoom(code) {
        db.ref(`rooms/${code}/players/${myName}`).onDisconnect().remove();

        // Listener separado para reacciones para no interferir con la UI de Ideas
        db.ref(`rooms/${code}/lastReaction`).on("value", (s) => {
          const val = s.val();
          if (!val || Date.now() - val.time > 2000) return;
          const container = document.getElementById("reaction-container");
          const pop = document.createElement("div");
          pop.className = "reaction-pop";
          pop.innerHTML = `<span style="font-size:50px">${val.emoji}</span><span style="font-size:10px; font-weight:900; background:rgba(0,0,0,0.5); padding:2px 8px; border-radius:10px;">${val.user}</span>`;
          container.appendChild(pop);
          setTimeout(() => pop.remove(), 2500);
        });

        db.ref("rooms/" + code).on("value", (s) => {
          const d = s.val();
          if (!d) return;
          if (d.players && d.players[myName] === "KICKED") {
            alert("EXPULSADO");
            logout();
            return;
          }
          const pKeys = d.players
            ? Object.keys(d.players).filter((k) => d.players[k] !== "KICKED")
            : [];
          const isIHost = d.host === myName;
          const amPlayer = d.players && d.players[myName];

          document.getElementById("room-code-display").innerText = code;
          document.getElementById("btn-logout").classList.remove("hidden");
          document
            .getElementById("trigger-reaction")
            .classList.remove("hidden");
          [
            "screen-lobby",
            "screen-room",
            "screen-game-order",
            "screen-game",
            "screen-voting",
          ].forEach((id) =>
            document.getElementById(id).classList.add("hidden")
          );

          if (d.status === "waiting") {
            document.getElementById("screen-room").classList.remove("hidden");
            document.getElementById("vote-results").classList.add("hidden");
            document.getElementById("mode-tag").innerText =
              "MODO: " + d.mode.toUpperCase();

            // L√ìGICA DE VISIBILIDAD DE IDEAS REFORZADA
            const ideasEnSala = d.ideas || {};
            const miIdeaEnviada = ideasEnSala.hasOwnProperty(myName);

            if (d.mode === "ideas" && amPlayer && !miIdeaEnviada) {
              document
                .getElementById("ideas-input-box")
                .classList.remove("hidden");
              document.getElementById("btn-send-idea").disabled = false;
              document.getElementById("btn-send-idea").innerText =
                "Enviar Idea";
            } else {
              document
                .getElementById("ideas-input-box")
                .classList.add("hidden");
            }

            if (isIHost) {
              document
                .getElementById("host-controls")
                .classList.remove("hidden");
              document
                .getElementById("manual-input-admin")
                .classList.toggle("hidden", d.mode !== "admin");
              if (d.mode === "ideas") {
                const ready = Object.keys(ideasEnSala).length;
                document.getElementById(
                  "ideas-status"
                ).innerText = `IDEAS: ${ready}/${pKeys.length}`;
              }
              document.getElementById("wait-msg").classList.add("hidden");
            } else {
              document.getElementById("wait-msg").classList.remove("hidden");
            }
            document.getElementById("player-list").innerHTML = pKeys
              .map(
                (u) =>
                  `<div class="player-card">${
                    isIHost && u !== myName
                      ? `<div class="kick-badge" onclick="kickPlayer('${u}')">√ó</div>`
                      : ""
                  }<img src="${getAvatar(
                    u
                  )}" class="avatar"><div class="flex flex-col text-left leading-none"><span class="font-black uppercase text-[11px]">${u}</span><span class="text-pink-500 font-bold text-[9px] mt-1">${
                    d.points ? d.points[u] || 0 : 0
                  } PTS</span></div><button class="status-badge ${
                    d.assignments && d.assignments[u]
                      ? d.assignments[u] === "mentiroso"
                        ? "bg-pink-600"
                        : "bg-green-600"
                      : "bg-zinc-600"
                  }"></button></div>`
              )
              .join("");
          } else if (d.status === "showing_order") {
            document
              .getElementById("screen-game-order")
              .classList.remove("hidden");
            document.getElementById("turn-order-list").innerHTML = d.turnOrder
              .map(
                (p, i) =>
                  `<div class="player-card text-white text-xs"><div class="bg-pink-600 text-white w-6 h-6 rounded-full flex items-center justify-center font-black text-xs text-center">${
                    i + 1
                  }</div><img src="${getAvatar(
                    p
                  )}" class="avatar"><span>${p}</span></div>`
              )
              .join("");
            if (isIHost)
              document
                .getElementById("host-start-trigger")
                .classList.remove("hidden");
          } else if (d.status === "started") {
            document.getElementById("screen-game").classList.remove("hidden");
            if (d.mode === "admin" && isIHost && !amPlayer) {
              document.getElementById("admin-view").classList.remove("hidden");
              document.getElementById("player-view").classList.add("hidden");
              document.getElementById("admin-word-info").innerText = d.word;
            } else {
              document.getElementById("admin-view").classList.add("hidden");
              document.getElementById("player-view").classList.remove("hidden");
              if (d.assignments && d.assignments[myName])
                showRole(d.assignments[myName], d.word, d.category);
            }
            if (isIHost)
              document
                .getElementById("host-game-controls")
                .classList.remove("hidden");
          } else if (d.status === "voting") {
            document.getElementById("screen-voting").classList.remove("hidden");
            const allV = d.votes && Object.keys(d.votes).length >= pKeys.length;
            if (amPlayer && !(d.votes && d.votes[myName])) {
              document.getElementById("vote-list").innerHTML = pKeys
                .map(
                  (u) =>
                    `<button onclick="castVote('${u}')" class="player-card w-full uppercase font-black text-white text-xs text-center"><img src="${getAvatar(
                      u
                    )}" class="avatar"><span>${u}</span></button>`
                )
                .join("");
            } else {
              document.getElementById("vote-list").innerHTML = pKeys
                .map(
                  (u) =>
                    `<div class="player-card opacity-50 text-white text-xs text-center"><img src="${getAvatar(
                      u
                    )}" class="avatar"><span class="font-black uppercase text-xs text-center">${u}</span>${
                      d.votes && d.votes[u]
                        ? '<span class="ml-auto text-green-500 font-bold">VOT√ì</span>'
                        : ""
                    }</div>`
                )
                .join("");
            }
            if (allV && !d.animShowed) {
              const liars = Object.entries(d.assignments)
                .filter(([p, r]) => r === "mentiroso")
                .map((e) => e[0]);
              const counts = {};
              Object.values(d.votes).forEach((a) =>
                a.forEach((v) => (counts[v] = (counts[v] || 0) + 1))
              );
              const target = Object.entries(counts).sort(
                (a, b) => b[1] - a[1]
              )[0][0];
              const targetIsLiar = d.assignments[target] === "mentiroso";
              if (isIHost) {
                db.ref(`rooms/${currentRoom}/animShowed`).set(true);
                Object.entries(d.assignments).forEach(([p, role]) => {
                  if (role === "mentiroso" && target !== p)
                    db.ref(`rooms/${currentRoom}/points/${p}`).transaction(
                      (v) => (v || 0) + 3
                    );
                  if (
                    role === "inocente" &&
                    targetIsLiar &&
                    d.votes[p] &&
                    d.votes[p].includes(target)
                  )
                    db.ref(`rooms/${currentRoom}/points/${p}`).transaction(
                      (v) => (v || 0) + 1
                    );
                });
              }
              const screen = document.getElementById("ejection-screen");
              document.getElementById("ejection-avatars-flow").innerHTML = liars
                .map(
                  (l) =>
                    `<div class="floating-avatar"><img src="${getAvatar(
                      l
                    )}" class="w-full h-full"></div>`
                )
                .join("");
              document.getElementById(
                "ejection-msg"
              ).innerHTML = `LOS MENTIROSOS ERAN:<br><span class="text-pink-500">${liars.join(
                " & "
              )}</span>`;
              screen.classList.add("active");
              setTimeout(() => {
                screen.classList.remove("active");
                document
                  .getElementById("vote-results")
                  .classList.remove("hidden");
                document.getElementById("results-display").innerHTML = pKeys
                  .map((p) => {
                    const isLi = d.assignments[p] === "mentiroso";
                    return `<div class="flex justify-between items-center ${
                      isLi
                        ? "bg-pink-600/20 border border-pink-600"
                        : "bg-white/5"
                    } p-2 rounded-lg text-left text-white"><div class="flex flex-col"><span class="text-[10px] font-black uppercase text-center text-center">${p}</span><span class="${
                      isLi ? "text-pink-500" : "text-zinc-500"
                    } text-[8px] font-bold uppercase text-center text-center">${
                      isLi ? "Mentiroso" : "Inocente"
                    }</span></div><span class="font-black text-xs text-white">${
                      counts[p] || 0
                    } VOTOS</span></div>`;
                  })
                  .join("");
                if (isIHost)
                  document
                    .getElementById("btn-final-reset")
                    .classList.remove("hidden");
              }, 5000);
            }
          }
        });
      }

      function startGame() {
        const num = parseInt(document.getElementById("liar-range").value);
        db.ref("rooms/" + currentRoom).once("value", (s) => {
          const d = s.val(),
            pKeys = Object.keys(d.players || {}).filter(
              (k) => d.players[k] !== "KICKED"
            );
          if (pKeys.length < num + 1) return alert("Pocos jugadores");
          if (
            d.mode === "ideas" &&
            (d.ideas ? Object.keys(d.ideas).length : 0) < pKeys.length
          )
            return alert("Faltan ideas");
          db.ref("rooms/" + currentRoom).update({
            status: "showing_order",
            turnOrder: shuffleArray([...pKeys]),
            animShowed: false,
          });
        });
      }
      function confirmStartGame() {
        db.ref("rooms/" + currentRoom).once("value", (s) => {
          const d = s.val(),
            num = parseInt(document.getElementById("liar-range").value);

        const dictionary = [
            { w: "LE√ìN", c: "ANIMALES" }, { w: "TIGRE", c: "ANIMALES" }, { w: "ELEFANTE", c: "ANIMALES" }, { w: "CEBRA", c: "ANIMALES" }, { w: "GIRAFA", c: "ANIMALES" }, { w: "DELF√çN", c: "ANIMALES" }, { w: "TIBUR√ìN", c: "ANIMALES" }, { w: "√ÅGUILA", c: "ANIMALES" }, { w: "PING√úINO", c: "ANIMALES" }, { w: "CANGURO", c: "ANIMALES" }, { w: "PANDA", c: "ANIMALES" }, { w: "LOBO", c: "ANIMALES" }, { w: "ZORRO", c: "ANIMALES" }, { w: "MONO", c: "ANIMALES" }, { w: "CABALLO", c: "ANIMALES" }, { w: "VACA", c: "ANIMALES" }, { w: "CERDO", c: "ANIMALES" }, { w: "OVEJA", c: "ANIMALES" }, { w: "GALLINA", c: "ANIMALES" }, { w: "PATO", c: "ANIMALES" }, { w: "CISNE", c: "ANIMALES" }, { w: "LORO", c: "ANIMALES" }, { w: "B√öHO", c: "ANIMALES" }, { w: "MURCI√âLAGO", c: "ANIMALES" }, { w: "RANA", c: "ANIMALES" }, { w: "COCODRILO", c: "ANIMALES" }, { w: "TORTUGA", c: "ANIMALES" }, { w: "SERPIENTE", c: "ANIMALES" }, { w: "BALLENA", c: "ANIMALES" }, { w: "PULPO", c: "ANIMALES" }, { w: "MEDUSA", c: "ANIMALES" }, { w: "ESTRELLA DE MAR", c: "ANIMALES" }, { w: "HORMIGA", c: "ANIMALES" }, { w: "ABEJA", c: "ANIMALES" }, { w: "MARIPOSA", c: "ANIMALES" }, { w: "ARA√ëA", c: "ANIMALES" }, { w: "ESCORPI√ìN", c: "ANIMALES" }, { w: "CAMELLO", c: "ANIMALES" }, { w: "HIPOP√ìTAMO", c: "ANIMALES" }, { w: "RINOCERONTE", c: "ANIMALES" }, { w: "PIZZA", c: "COMIDA" }, { w: "HAMBURGUESA", c: "COMIDA" }, { w: "SUSHI", c: "COMIDA" }, { w: "PASTA", c: "COMIDA" }, { w: "ENSALADA", c: "COMIDA" }, { w: "PAELLA", c: "COMIDA" }, { w: "TACO", c: "COMIDA" }, { w: "BURRITO", c: "COMIDA" }, { w: "LASA√ëA", c: "COMIDA" }, { w: "SOPA", c: "COMIDA" }, { w: "FILETE", c: "COMIDA" }, { w: "POLLO ASADO", c: "COMIDA" }, { w: "PESCADO", c: "COMIDA" }, { w: "MARISCO", c: "COMIDA" }, { w: "TORTILLA", c: "COMIDA" }, { w: "CROQUETAS", c: "COMIDA" }, { w: "JAM√ìN", c: "COMIDA" }, { w: "QUESO", c: "COMIDA" }, { w: "PAN", c: "COMIDA" }, { w: "ARROZ", c: "COMIDA" }, { w: "MANZANA", c: "COMIDA" }, { w: "PL√ÅTANO", c: "COMIDA" }, { w: "FRESA", c: "COMIDA" }, { w: "NARANJA", c: "COMIDA" }, { w: "UVA", c: "COMIDA" }, { w: "SAND√çA", c: "COMIDA" }, { w: "PI√ëA", c: "COMIDA" }, { w: "KIWI", c: "COMIDA" }, { w: "TOMATE", c: "COMIDA" }, { w: "LECHUGA", c: "COMIDA" }, { w: "ZANAHORIA", c: "COMIDA" }, { w: "PATATA", c: "COMIDA" }, { w: "CEBOLLA", c: "COMIDA" }, { w: "AJO", c: "COMIDA" }, { w: "CHOCOLATE", c: "COMIDA" }, { w: "HELADO", c: "COMIDA" }, { w: "TARTA", c: "COMIDA" }, { w: "GALLETA", c: "COMIDA" }, { w: "DONUT", c: "COMIDA" }, { w: "CAF√â", c: "COMIDA" }, { w: "T√â", c: "COMIDA" }, { w: "CERVEZA", c: "COMIDA" }, { w: "VINO", c: "COMIDA" }, { w: "REFRESCO", c: "COMIDA" }, { w: "ZUMO", c: "COMIDA" }, { w: "AGUA", c: "COMIDA" }, { w: "MESA", c: "HOGAR" }, { w: "SILLA", c: "HOGAR" }, { w: "SOF√Å", c: "HOGAR" }, { w: "CAMA", c: "HOGAR" }, { w: "ARMARIO", c: "HOGAR" }, { w: "ESTANTER√çA", c: "HOGAR" }, { w: "L√ÅMPARA", c: "HOGAR" }, { w: "ESPEJO", c: "HOGAR" }, { w: "CUADRO", c: "HOGAR" }, { w: "RELOJ", c: "HOGAR" }, { w: "TELEVISOR", c: "HOGAR" }, { w: "ORDENADOR", c: "HOGAR" }, { w: "TEL√âFONO", c: "HOGAR" }, { w: "NEVERA", c: "HOGAR" }, { w: "LAVADORA", c: "HOGAR" }, { w: "MICROONDAS", c: "HOGAR" }, { w: "HORNO", c: "HOGAR" }, { w: "BATIDORA", c: "HOGAR" }, { w: "CAFETERA", c: "HOGAR" }, { w: "PLATO", c: "HOGAR" }, { w: "VASO", c: "HOGAR" }, { w: "TAZA", c: "HOGAR" }, { w: "TENEDOR", c: "HOGAR" }, { w: "CUCHILLO", c: "HOGAR" }, { w: "CUCHARA", c: "HOGAR" }, { w: "SART√âN", c: "HOGAR" }, { w: "OLLA", c: "HOGAR" }, { w: "TOALLA", c: "HOGAR" }, { w: "S√ÅBANA", c: "HOGAR" }, { w: "ALMOHADA", c: "HOGAR" }, { w: "CORTINA", c: "HOGAR" }, { w: "ALFOMBRA", c: "HOGAR" }, { w: "PUERTA", c: "HOGAR" }, { w: "VENTANA", c: "HOGAR" }, { w: "LLAVE", c: "HOGAR" }, { w: "MARTILLO", c: "HOGAR" }, { w: "DESTORNILLADOR", c: "HOGAR" }, { w: "ESCOBA", c: "HOGAR" }, { w: "CUBO", c: "HOGAR" }, { w: "PLANCHA", c: "HOGAR" }, { w: "F√öTBOL", c: "DEPORTES" }, { w: "BALONCESTO", c: "DEPORTES" }, { w: "TENIS", c: "DEPORTES" }, { w: "NATACI√ìN", c: "DEPORTES" }, { w: "CICLISMO", c: "DEPORTES" }, { w: "ATLETISMO", c: "DEPORTES" }, { w: "BOXEO", c: "DEPORTES" }, { w: "GOLF", c: "DEPORTES" }, { w: "VOLEIBOL", c: "DEPORTES" }, { w: "RUGBY", c: "DEPORTES" }, { w: "B√âISBOL", c: "DEPORTES" }, { w: "ESQU√ç", c: "DEPORTES" }, { w: "SURF", c: "DEPORTES" }, { w: "SKATE", c: "DEPORTES" }, { w: "KARATE", c: "DEPORTES" }, { w: "YOGA", c: "DEPORTES" }, { w: "AJEDREZ", c: "DEPORTES" }, { w: "BILLAR", c: "DEPORTES" }, { w: "DARDOS", c: "DEPORTES" }, { w: "VIDEOJUEGOS", c: "OCIO" }, { w: "CINE", c: "OCIO" }, { w: "TEATRO", c: "OCIO" }, { w: "M√öSICA", c: "OCIO" }, { w: "LECTURA", c: "OCIO" }, { w: "PINTURA", c: "OCIO" }, { w: "BAILE", c: "OCIO" }, { w: "FOTOGRAF√çA", c: "OCIO" }, { w: "VIAJAR", c: "OCIO" }, { w: "CAMPING", c: "OCIO" }, { w: "SENDERISMO", c: "OCIO" }, { w: "PESCA", c: "OCIO" }, { w: "NAVEGACI√ìN", c: "OCIO" }, { w: "M√âDICO", c: "PROFESIONES" }, { w: "ENFERMERO", c: "PROFESIONES" }, { w: "DENTISTA", c: "PROFESIONES" }, { w: "PROFESOR", c: "PROFESIONES" }, { w: "CIENT√çFICO", c: "PROFESIONES" }, { w: "INGENIERO", c: "PROFESIONES" }, { w: "ARQUITECTO", c: "PROFESIONES" }, { w: "ABOGADO", c: "PROFESIONES" }, { w: "POLIC√çA", c: "PROFESIONES" }, { w: "BOMBERO", c: "PROFESIONES" }, { w: "PILOTO", c: "PROFESIONES" }, { w: "ASTRONAUTA", c: "PROFESIONES" }, { w: "COCINERO", c: "PROFESIONES" }, { w: "CAMARERO", c: "PROFESIONES" }, { w: "ARTISTA", c: "PROFESIONES" }, { w: "M√öSICO", c: "PROFESIONES" }, { w: "ACTOR", c: "PROFESIONES" }, { w: "ESCRITOR", c: "PROFESIONES" }, { w: "PERIODISTA", c: "PROFESIONES" }, { w: "FOT√ìGRAFO", c: "PROFESIONES" }, { w: "DISE√ëADOR", c: "PROFESIONES" }, { w: "PROGRAMADOR", c: "PROFESIONES" }, { w: "MEC√ÅNICO", c: "PROFESIONES" }, { w: "ELECTRICISTA", c: "PROFESIONES" }, { w: "FONTANERO", c: "PROFESIONES" }, { w: "CARPINTERO", c: "PROFESIONES" }, { w: "ALBA√ëIL", c: "PROFESIONES" }, { w: "GRANJERO", c: "PROFESIONES" }, { w: "VETERINARIO", c: "PROFESIONES" }, { w: "PELUQUERO", c: "PROFESIONES" }, { w: "PLAYA", c: "LUGARES" }, { w: "MONTA√ëA", c: "LUGARES" }, { w: "BOSQUE", c: "LUGARES" }, { w: "DESIERTO", c: "LUGARES" }, { w: "SELVA", c: "LUGARES" }, { w: "R√çO", c: "LUGARES" }, { w: "LAGO", c: "LUGARES" }, { w: "OC√âANO", c: "LUGARES" }, { w: "ISLA", c: "LUGARES" }, { w: "VOLC√ÅN", c: "LUGARES" }, { w: "CIUDAD", c: "LUGARES" }, { w: "PUEBLO", c: "LUGARES" }, { w: "PARQUE", c: "LUGARES" }, { w: "ZOO", c: "LUGARES" }, { w: "MUSEO", c: "LUGARES" }, { w: "BIBLIOTECA", c: "LUGARES" }, { w: "ESCUELA", c: "LUGARES" }, { w: "UNIVERSIDAD", c: "LUGARES" }, { w: "HOSPITAL", c: "LUGARES" }, { w: "FARMACIA", c: "LUGARES" }, { w: "SUPERMERCADO", c: "LUGARES" }, { w: "RESTAURANTE", c: "LUGARES" }, { w: "HOTEL", c: "LUGARES" }, { w: "AEROPUERTO", c: "LUGARES" }, { w: "ESTACI√ìN", c: "LUGARES" }, { w: "CASTILLO", c: "LUGARES" }, { w: "IGLESIA", c: "LUGARES" }, { w: "PUENTE", c: "LUGARES" }, { w: "RASCACIELOS", c: "LUGARES" }, { w: "CUEVA", c: "LUGARES" }, { w: "COCHE", c: "TRANSPORTE" }, { w: "AUTOB√öS", c: "TRANSPORTE" }, { w: "TREN", c: "TRANSPORTE" }, { w: "METRO", c: "TRANSPORTE" }, { w: "TAXI", c: "TRANSPORTE" }, { w: "MOTO", c: "TRANSPORTE" }, { w: "BICICLETA", c: "TRANSPORTE" }, { w: "PATINETE", c: "TRANSPORTE" }, { w: "CAMI√ìN", c: "TRANSPORTE" }, { w: "FURGONETA", c: "TRANSPORTE" }, { w: "BARCO", c: "TRANSPORTE" }, { w: "SUBMARINO", c: "TRANSPORTE" }, { w: "HELIC√ìPTERO", c: "TRANSPORTE" }, { w: "COHETE", c: "TRANSPORTE" }, { w: "GLOBO", c: "TRANSPORTE" }, { w: "CAMISETA", c: "ROPA" }, { w: "PANTAL√ìN", c: "ROPA" }, { w: "VESTIDO", c: "ROPA" }, { w: "FALDA", c: "ROPA" }, { w: "CHAQUETA", c: "ROPA" }, { w: "ABRIGO", c: "ROPA" }, { w: "JERSEY", c: "ROPA" }, { w: "ZAPATOS", c: "ROPA" }, { w: "ZAPATILLAS", c: "ROPA" }, { w: "BOTAS", c: "ROPA" }, { w: "SOMBRERO", c: "ROPA" }, { w: "GORRA", c: "ROPA" }, { w: "GUANTES", c: "ROPA" }, { w: "BUFANDA", c: "ROPA" }, { w: "CINTUR√ìN", c: "ROPA" }, { w: "GAFAS", c: "ACCESORIOS" }, { w: "RELOJ DE PULSERA", c: "ACCESORIOS" }, { w: "ANILLO", c: "ACCESORIOS" }, { w: "COLLAR", c: "ACCESORIOS" }, { w: "PENDIENTES", c: "ACCESORIOS" }, { w: "BOLSO", c: "ACCESORIOS" }, { w: "MOCHILA", c: "ACCESORIOS" }, { w: "PARAGUAS", c: "ACCESORIOS" }, { w: "√ÅATOMO", c: "CIENCIA" }, { w: "C√âLULA", c: "CIENCIA" }, { w: "PLANETA", c: "CIENCIA" }, { w: "ESTRELLA", c: "CIENCIA" }, { w: "GALAXIA", c: "CIENCIA" }, { w: "GRAVEDAD", c: "CIENCIA" }, { w: "ENERG√çA", c: "CIENCIA" }, { w: "ROBOT", c: "TECNOLOG√çA" }, { w: "INTERNET", c: "TECNOLOG√çA" }, { w: "SOFTWARE", c: "TECNOLOG√çA" }, { w: "BATER√çA", c: "TECNOLOG√çA" }, { w: "C√ÅMARA", c: "TECNOLOG√çA" }, { w: "ALTAVOZ", c: "TECNOLOG√çA" }, { w: "PANTALLA", c: "TECNOLOG√çA" }, { w: "TECLADO", c: "TECNOLOG√çA" }, { w: "RAT√ìN", c: "TECNOLOG√çA" }, { w: "SAT√âLITE", c: "TECNOLOG√çA" }, { w: "DRON", c: "TECNOLOG√çA" }, { w: "GUITARRA", c: "M√öSICA" }, { w: "PIANO", c: "M√öSICA" }, { w: "VIOL√çN", c: "M√öSICA" }, { w: "BATER√çA M√öSICAL", c: "M√öSICA" }, { w: "FLAUTA", c: "M√öSICA" }, { w: "TROMPETA", c: "M√öSICA" }, { w: "ACORDE√ìN", c: "M√öSICA" }, { w: "HARPA", c: "M√öSICA" }, { w: "PIR√ÅMIDE", c: "HISTORIA" }, { w: "MOMIA", c: "HISTORIA" }, { w: "CABALLERO", c: "HISTORIA" }, { w: "VIKINGO", c: "HISTORIA" }, { w: "PIRATA", c: "HISTORIA" }, { w: "DINOSAURIO", c: "HISTORIA" }, { w: "F√ìSIL", c: "HISTORIA" }, { w: "BR√öJULA", c: "HISTORIA" }, { w: "MAPA", c: "HISTORIA" }, { w: "ESTATUA", c: "ARTE" }, { w: "PINCEL", c: "ARTE" }, { w: "LIENZO", c: "ARTE" }, { w: "ESCULTURA", c: "ARTE" }, { w: "POES√çA", c: "ARTE" }, { w: "C√ìMIC", c: "ARTE" }, { w: "MANGA", c: "ARTE" }, { w: "DIBUJO ANIMADO", c: "ARTE" }, { w: "FUEGO", c: "ELEMENTOS" }, { w: "HIELO", c: "ELEMENTOS" }, { w: "RAYO", c: "ELEMENTOS" }, { w: "VIENTO", c: "ELEMENTOS" }, { w: "TERREMOTO", c: "ELEMENTOS" }, { w: "LLUVIA", c: "ELEMENTOS" }, { w: "NIEVE", c: "ELEMENTOS" }, { w: "NIEBLA", c: "ELEMENTOS" }, { w: "ARCOIRIS", c: "ELEMENTOS" }, { w: "ECLIPSE", c: "ELEMENTOS" }
          ];
          let item;
          if (d.mode === "admin") {
            const manual = document
              .getElementById("admin-manual-word")
              .value.trim()
              .toUpperCase();
            item = manual
              ? { w: manual, c: "MANUAL" }
              : dictionary[Math.floor(Math.random() * dictionary.length)];
          } else if (d.mode === "ideas") {
            const pool = Object.values(d.ideas);
            item = pool[Math.floor(Math.random() * pool.length)];
          } else
            item = dictionary[Math.floor(Math.random() * dictionary.length)];
          let assigns = {};
          let shuffled = shuffleArray([...d.turnOrder]);
          shuffled.forEach(
            (p, i) => (assigns[p] = i < num ? "mentiroso" : "inocente")
          );
          db.ref("rooms/" + currentRoom).update({
            status: "started",
            word: item.w,
            category: item.c,
            assignments: assigns,
            votes: null,
            animShowed: false,
          });
        });
      }
      function openVoting() {
        db.ref(`rooms/${currentRoom}`).update({
          status: "voting",
          votes: null,
        });
      }
      function castVote(t) {
        db.ref(`rooms/${currentRoom}`).once("value", (s) => {
          const d = s.val(),
            max = Object.values(d.assignments).filter(
              (r) => r === "mentiroso"
            ).length;
          if (!window.tmpV) window.tmpV = [];
          if (window.tmpV.includes(t))
            window.tmpV = window.tmpV.filter((v) => v !== t);
          else if (window.tmpV.length < max) window.tmpV.push(t);
          if (window.tmpV.length === max) {
            db.ref(`rooms/${currentRoom}/votes/${myName}`).set(window.tmpV);
            window.tmpV = [];
          }
        });
      }
      function showRole(r, w, c) {
        document.getElementById("role-title").innerText =
          r === "mentiroso" ? "MENTIROSO" : "INOCENTE";
        document.getElementById("role-title").style.color =
          r === "mentiroso" ? "#db2777" : "#fff";
        document.getElementById("word-display").innerText =
          r === "mentiroso" ? "???" : w;
        document.getElementById("hint-text").innerText =
          (r === "mentiroso" ? "Pista: " : "Categor√≠a: ") + c;
      }
      function resetGame() {
        db.ref("rooms/" + currentRoom).update({
          status: "waiting",
          assignments: null,
          turnOrder: null,
          votes: null,
          animShowed: false,
          lastReaction: null,
          ideas: null,
        });
      }
    </script>
  </body>
</html>
