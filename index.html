<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>MENTIROSO - Online</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Archivo+Black&family=Inter:wght@400;900&display=swap");
      :root { --pink: #db2777; }
      body { background-color: #000; color: #fff; font-family: "Inter", sans-serif; margin: 0; overflow: hidden; -webkit-tap-highlight-color: transparent; user-select: none; }
      section { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; position: sticky; top: 0; background: #050505; padding: 1.5rem; }
      .hero-title { font-family: "Archivo Black", sans-serif; font-size: clamp(2rem, 8vw, 5rem); line-height: 0.85; text-align: center; text-transform: uppercase; background: linear-gradient(to bottom, #fff, #444); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
      .custom-input { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); padding: 0.8rem; border-radius: 12px; width: 100%; max-width: 320px; text-align: center; font-weight: 700; color: white; margin-bottom: 0.5rem; outline: none; }
      .btn-action { background: #fff; color: #000; font-weight: 900; padding: 1rem; text-transform: uppercase; width: 100%; max-width: 320px; border-radius: 12px; transition: 0.3s; border: none; cursor: pointer; }
      .player-card { position: relative; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); padding: 0.6rem; border-radius: 16px; display: flex; align-items: center; gap: 8px; width: 100%; transition: 0.2s; }
      .avatar { width: 35px; height: 35px; border-radius: 50%; background: #1a1a1a; border: 2px solid var(--pink); }
      .blur-content { filter: blur(25px); opacity: 0; transition: 0.3s; pointer-events: none; }
      .show-content { filter: blur(0); opacity: 1; }
      .hidden { display: none !important; }
      .btn-back { position: fixed; top: 20px; left: 20px; z-index: 100; background: rgba(255, 255, 255, 0.1); padding: 8px 12px; border-radius: 10px; font-size: 10px; font-weight: 900; text-transform: uppercase; border: 1px solid rgba(255, 255, 255, 0.1); color: white; }
      
      .selected-vote { background: rgba(219, 39, 119, 0.2) !important; border-color: var(--pink) !important; transform: scale(1.02); }

      /* Controles Flotantes */
      #trigger-reaction { position: fixed; bottom: 85px; right: 20px; width: 55px; height: 55px; background: var(--pink); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; z-index: 201; box-shadow: 0 0 20px rgba(219,39,119,0.4); }
      #btn-random-avatar { position: fixed; bottom: 20px; right: 22.5px; width: 50px; height: 50px; background: #fff; color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; z-index: 201; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
      #reaction-menu { position: fixed; bottom: 150px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 200; transition: 0.3s; transform: scale(0); opacity: 0; transform-origin: bottom right; }
      #reaction-menu.open { transform: scale(1); opacity: 1; }
      .reaction-btn { width: 45px; height: 45px; background: #1a1a1a; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; }
      .reaction-pop { position: absolute; left: 50%; bottom: 20%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; animation: reactionFloat 2.5s ease-out forwards; z-index: 1000;}
      
      @keyframes reactionFloat { 0% { transform: translate(-50%, 0); opacity: 0; scale: 0.5; } 15% { transform: translate(-50%, -20px); opacity: 1; scale: 1.2; } 100% { transform: translate(-50%, -100px); opacity: 0; scale: 1; } }
      #ejection-screen, #tie-screen, #event-screen { position: fixed; inset: 0; background: #000; z-index: 500; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.5s opacity; }
      #ejection-screen.active, #tie-screen.active, #event-screen.active { opacity: 1; pointer-events: auto; }
      .floating-avatar { width: 100px; height: 100px; animation: floatX 4.5s infinite linear; position: absolute; left: -150px; }
      @keyframes floatX { 0% { transform: translateX(-150vw) rotate(0deg); } 100% { transform: translateX(250vw) rotate(1000deg); } }

      .signature { 
        font-size: 10px; font-weight: 900; text-transform: uppercase; letter-spacing: 2px; 
        background: linear-gradient(90deg, #444, #fff, #444);
        background-size: 200% auto;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: shine 3s linear infinite;
        margin-top: 25px;
      }
      @keyframes shine { to { background-position: 200% center; } }
      
      .event-card { background: #facc15; color: #000; padding: 10px 20px; border-radius: 10px; font-weight: 900; text-transform: uppercase; animation: pulse 1s infinite; }
      @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    </style>
  </head>
  <body>
    <button id="btn-logout" onclick="logout()" class="btn-back hidden">‚Üê Salir</button>
    
    <div id="btn-random-avatar" class="hidden" onclick="randomizeAvatarInRoom()">üé≤</div>
    <div id="trigger-reaction" class="hidden" onclick="document.getElementById('reaction-menu').classList.toggle('open')">üí¨</div>
    <div id="reaction-container"></div>
    <div id="reaction-menu">
      <button onclick="sendReaction('ü¶ê')" class="reaction-btn">ü¶ê</button>
      <button onclick="sendReaction('ü§´')" class="reaction-btn">ü§´</button>
      <button onclick="sendReaction('üßê')" class="reaction-btn">üßê</button>
      <button onclick="sendReaction('üòÖ')" class="reaction-btn">üòÖ</button>
      <button onclick="sendReaction('üî•')" class="reaction-btn">üî•</button>
    </div>

    <div id="ejection-screen">
      <div id="ejection-avatars-flow" class="w-full h-32 relative flex items-center"></div>
      <p id="ejection-msg" class="font-black text-center text-white uppercase mt-12 text-2xl"></p>
    </div>

    <div id="tie-screen">
        <div id="tie-icon" class="text-6xl animate-bounce mb-4">‚öñÔ∏è</div>
        <p class="hero-title !text-[2.5rem]">EMPATE</p>
        <p id="tie-msg" class="text-white font-bold uppercase text-center mt-4 px-6 text-sm"></p>
        <p class="text-pink-500 font-black text-[10px] mt-8 tracking-widest animate-pulse">REINICIANDO VOTACI√ìN...</p>
    </div>

    <div id="event-screen">
        <div class="event-card">‚ö†Ô∏è EVENTO: PUNTOS X2 ‚ö†Ô∏è</div>
        <p class="text-white font-black mt-4 text-center">¬°LOS PUNTOS DE ESTA RONDA VALEN EL DOBLE!</p>
    </div>

    <div class="stack-container">
      <section id="screen-lobby">
        <h1 class="hero-title">MENTI<br />ROSO</h1>
        <div class="text-6xl my-6 text-center animate-bounce">ü¶ê</div>
        <div class="flex gap-2 w-full max-w-[320px] mb-4">
            <input type="text" id="username" class="custom-input !mb-0" placeholder="TU NOMBRE..." />
            <button onclick="randomizeName()" class="bg-zinc-800 px-4 rounded-xl text-xl border border-white/10">üé≤</button>
        </div>
        <div id="lobby-main" class="flex flex-col gap-3 w-full items-center">
          <button onclick="showCreateOptions()" class="btn-action !bg-pink-600 !text-white text-xs">CREAR SALA ONLINE</button>
          <div class="flex gap-2 w-full max-w-[320px]">
            <input type="text" id="roomInput" class="custom-input !mb-0" placeholder="C√ìDIGO" />
            <button onclick="joinRoom()" class="bg-zinc-800 px-6 rounded-xl font-black uppercase text-xs text-white border border-white/10">Unirse</button>
          </div>
        </div>
        <div id="create-options" class="hidden flex flex-col gap-2 w-full items-center bg-zinc-900/50 p-6 rounded-3xl border border-white/10">
          <button onclick="finalizeCreation('admin')" class="btn-action !py-3 text-xs">Modo Admin</button>
          <button onclick="finalizeCreation('normal')" class="btn-action !py-3 text-xs">Modo Normal</button>
          <button onclick="finalizeCreation('ideas')" class="btn-action !py-3 text-xs">Modo Ideas</button>
          <button onclick="showCreateOptions(false)" class="text-[10px] uppercase font-bold opacity-50 mt-2 text-white">Cancelar</button>
        </div>
        <p class="signature">by Marcos Perez Esteban</p>
      </section>

      <section id="screen-room" class="hidden">
        <div class="text-center w-full max-w-lg px-4">
          <div id="mode-tag" class="inline-block bg-pink-600 text-white text-[8px] font-black uppercase px-3 py-1 rounded-full mb-2">---</div>
          <h2 id="room-code-display" class="hero-title !text-[3.5rem] mb-2">----</h2>
          
          <button onclick="shareWhatsApp()" class="bg-green-600 text-[10px] font-black py-2 px-4 rounded-full mb-4 uppercase flex items-center gap-2 mx-auto">Invitar Amigos üì≤</button>

          <div id="ideas-input-box" class="hidden bg-zinc-900 border border-pink-600/50 p-5 rounded-2xl mb-6 shadow-2xl">
            <input type="text" id="idea-word" class="custom-input !text-xs !py-3" placeholder="Palabra secreta" />
            <input type="text" id="idea-cat" class="custom-input !text-xs !py-3" placeholder="Categor√≠a" />
            <button id="btn-send-idea" onclick="sendIdea()" class="btn-action !bg-pink-600 !text-white !py-3 text-xs">Enviar Idea</button>
          </div>
          <div id="player-list" class="grid grid-cols-2 gap-2 mt-6 mb-6 max-h-[40vh] overflow-y-auto"></div>
          <div id="host-controls" class="hidden bg-zinc-900 p-6 rounded-3xl border border-white/10 w-full max-w-[320px] mx-auto">
            <div id="manual-input-admin" class="hidden mb-4"><input type="text" id="admin-manual-word" class="custom-input !text-xs" placeholder="Palabra Secreta..." /></div>
            <div class="mb-4">
                <label class="text-[10px] font-black uppercase text-zinc-500 block mb-1">Mentirosos: <span id="liar-count-val-online" class="text-pink-500">1</span></label>
                <input type="range" id="liar-range" min="1" max="3" value="1" oninput="document.getElementById('liar-count-val-online').innerText = this.value" />
            </div>
            <button onclick="startGame()" class="btn-action !bg-white !text-black text-xs">INICIAR RONDA</button>
          </div>
          <p class="signature">by Marcos Perez Esteban</p>
        </div>
      </section>

      <section id="screen-game-order" class="hidden text-center">
        <h2 class="hero-title !text-[3rem] mb-6">TURNO</h2>
        <div id="turn-order-list" class="flex flex-col gap-3 w-full max-w-sm px-4 mx-auto"></div>
        <button id="host-start-trigger" onclick="confirmStartGame()" class="btn-action !bg-pink-600 !text-white mt-8 hidden">VER ROLES</button>
      </section>

      <section id="screen-game" class="hidden">
        <div id="admin-view" class="hidden text-center">
            <div class="bg-zinc-900 p-8 rounded-[2.5rem] border border-white/10"><p id="admin-word-info" class="text-4xl font-black uppercase"></p></div>
        </div>
        <div id="player-view" class="border-2 border-white/10 p-8 text-center w-full max-w-sm rounded-[2.5rem] bg-zinc-900/50 mx-auto">
          <div id="blur-wrapper" class="blur-content">
            <h2 id="role-title" class="text-5xl font-black uppercase mb-8">...</h2>
            <div id="word-display" class="font-black text-4xl text-yellow-400 mb-4 uppercase">---</div>
            <p id="hint-text" class="text-zinc-400 text-xs font-bold uppercase border-t border-white/5 pt-4"></p>
          </div>
          <button onmousedown="toggleReveal(true)" onmouseup="toggleReveal(false)" ontouchstart="toggleReveal(true)" ontouchend="toggleReveal(false)" class="mt-8 bg-white text-black text-[11px] font-black py-5 px-10 rounded-2xl w-full">MANT√âN PARA VER</button>
        </div>
        <div id="host-game-controls" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 w-[90%] max-w-[320px] z-[100]">
          <button onclick="openVoting()" class="btn-action !bg-pink-600 !text-white shadow-xl">ABRIR VOTACI√ìN</button>
        </div>
      </section>

      <section id="screen-voting" class="hidden text-center">
        <h2 class="hero-title !text-[3rem] mb-2">¬øQUI√âN ES?</h2>
        <p id="vote-instruction" class="text-pink-500 font-black text-[10px] uppercase tracking-widest mb-6">Selecciona al mentiroso</p>
        <div id="vote-list" class="flex flex-col gap-3 w-full max-w-sm px-4 mx-auto"></div>
        <div id="vote-results" class="hidden w-full max-w-sm px-4 mt-6 bg-zinc-900/80 p-6 rounded-3xl border border-white/10 mx-auto">
          <div id="results-display" class="flex flex-col gap-2 mb-6"></div>
          <button id="btn-final-reset" onclick="resetGame()" class="btn-action !bg-white !text-black mt-6 text-xs hidden">Nueva Ronda</button>
        </div>
      </section>
    </div>

    <script>
      var currentRoom = null, myName = "", db = null, tmpV = [], avatarSeed = Math.floor(Math.random()*9999);
      const firebaseConfig = {
        apiKey: "AIzaSyCRoM4Fuz5eGGnXSwNYRn-nf8oII_ulLuQ",
        authDomain: "mentiroso-marcos-perez.firebaseapp.com",
        databaseURL: "https://mentiroso-marcos-perez-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "mentiroso-marcos-perez",
        storageBucket: "mentiroso-marcos-perez.firebasestorage.app",
        messagingSenderId: "968925541268",
        appId: "1:968925541268:web:97a255db8eeff952b71581",
      };
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();


      // randomizar nombre
      function randomizeName() {
        const adjs = ["LOCO", "FIERO", "LISTO", "RAPIDO", "SILENCIOSO", "ASTUTO", "BRAVO", "ZEN"];
        const nouns = ["GAMBA", "TIGRE", "LEON", "PULPO", "ZORRO", "LOBO", "HALCON", "MONO"];
        document.getElementById('username').value = adjs[Math.floor(Math.random()*adjs.length)] + "_" + nouns[Math.floor(Math.random()*nouns.length)];
      }

      function shareWhatsApp() {
        const text = `¬°√önete a MENTIROSO! ü¶ê\nSala: ${currentRoom}\nLink: ${window.location.origin}${window.location.pathname}?join=${currentRoom}`;
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, "_blank");
      }

      function randomizeAvatarInRoom() {
        avatarSeed = Math.floor(Math.random()*9999);
        if (currentRoom && myName) db.ref(`rooms/${currentRoom}/players/${myName}`).set(avatarSeed);
      }

      function getAvatar(seed) { return `https://api.dicebear.com/7.x/bottts/svg?seed=${seed}`; }
      function shuffleArray(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }

      window.onload = () => {
        const params = new URLSearchParams(window.location.search);
        if (params.get("join")) document.getElementById("roomInput").value = params.get("join").toUpperCase();
        const sR = localStorage.getItem("mentiroso_room"), sN = localStorage.getItem("mentiroso_name");
        if (sR && sN) {
          db.ref("rooms/" + sR).once("value", (s) => {
            if (s.exists()) { myName = sN; currentRoom = sR; db.ref(`rooms/${sR}/players/${sN}`).set(avatarSeed); listenToRoom(sR); }
            else logout();
          });
        } else { document.getElementById("screen-lobby").classList.remove("hidden"); }
      };

      function logout() { localStorage.clear(); location.reload(); }
      function showCreateOptions(s = true) { document.getElementById("lobby-main").classList.toggle("hidden", s); document.getElementById("create-options").classList.toggle("hidden", !s); }
      function toggleReveal(s) { document.getElementById("blur-wrapper").className = s ? "show-content" : "blur-content"; }
      function kickPlayer(p) { if (confirm(`¬øExpulsar a ${p}?`)) db.ref(`rooms/${currentRoom}/players/${p}`).set("KICKED"); }
      function sendReaction(emoji) { if (currentRoom) db.ref(`rooms/${currentRoom}/lastReaction`).set({ user: myName, emoji, time: Date.now() }); }

      function finalizeCreation(m) {
        let n = document.getElementById("username").value.trim().toUpperCase();
        if (!n) return alert("Escribe un nombre...");
        const c = Math.random().toString(36).substring(2, 6).toUpperCase();
        myName = n; currentRoom = c;
        db.ref("rooms/" + c).set({ host: n, status: "waiting", mode: m, players: { [n]: avatarSeed }, points: { [n]: 0 } }).then(() => {
          localStorage.setItem("mentiroso_room", c); localStorage.setItem("mentiroso_name", n); listenToRoom(c);
        });
      }

      function joinRoom() {
        let n = document.getElementById("username").value.trim().toUpperCase();
        const c = document.getElementById("roomInput").value.trim().toUpperCase();
        if (!c || !n) return alert("Faltan datos");
        db.ref("rooms/" + c).once("value", (s) => {
          if (!s.exists()) return alert("La sala no existe");
          if (s.val().players && s.val().players[n]) n = n + "_" + Math.floor(Math.random()*99);
          myName = n; currentRoom = c;
          localStorage.setItem("mentiroso_room", c); localStorage.setItem("mentiroso_name", n);
          db.ref(`rooms/${c}/players/${n}`).set(avatarSeed);
          db.ref(`rooms/${c}/points/${n}`).transaction(p => p || 0);
          listenToRoom(c);
        });
      }

      function listenToRoom(code) {
        db.ref(`rooms/${code}/players/${myName}`).onDisconnect().remove();
        document.getElementById("btn-random-avatar").classList.remove("hidden");

        db.ref(`rooms/${code}/lastReaction`).on("value", (s) => {
          const val = s.val(); if (!val || Date.now() - val.time > 2000) return;
          const pop = document.createElement("div"); pop.className = "reaction-pop";
          pop.innerHTML = `<span style="font-size:50px">${val.emoji}</span><span style="background:rgba(0,0,0,0.5); padding:2px 8px; border-radius:10px; font-size:10px; font-weight:bold;">${val.user}</span>`;
          document.getElementById("reaction-container").appendChild(pop); setTimeout(() => pop.remove(), 2500);
        });

        db.ref("rooms/" + code).on("value", (s) => {
          const d = s.val(); if (!d) return;
          if (d.players && d.players[myName] === "KICKED") { alert("Has sido expulsado"); logout(); return; }
          const pKeys = d.players ? Object.keys(d.players).filter(k => d.players[k] !== "KICKED") : [];
          const isIHost = d.host === myName;

          document.getElementById("room-code-display").innerText = code;
          document.getElementById("btn-logout").classList.remove("hidden");
          document.getElementById("trigger-reaction").classList.remove("hidden");
          ["screen-lobby", "screen-room", "screen-game-order", "screen-game", "screen-voting"].forEach(id => document.getElementById(id).classList.add("hidden"));

          if (d.status === "waiting") {
            document.getElementById("vote-results").classList.add("hidden");
            document.getElementById("btn-final-reset").classList.add("hidden");
            document.getElementById("screen-room").classList.remove("hidden");
            document.getElementById("mode-tag").innerText = "MODO: " + d.mode.toUpperCase();

            //ESCONDEMOS EL PANEL DE IDEAS
            if (d.mode === "ideas" && d.players[myName] && !(d.ideas && d.ideas[myName])) document.getElementById("ideas-input-box").classList.remove("hidden");
            else document.getElementById("ideas-input-box").classList.add("hidden");
            //MOSTRAMOS LOS CONTROLES DE HOST
            if (isIHost) document.getElementById("host-controls").classList.remove("hidden");

            //MOSTRAMOS LOS JUGADORES
            document.getElementById("player-list").innerHTML = pKeys.map(u => 
                `<div class="player-card">${isIHost && u !== myName ? `<div class="kick-badge" onclick="kickPlayer('${u}')">√ó</div>` : ""}
                <img src="${getAvatar(d.players[u])}" class="avatar"><div class="flex flex-col text-left leading-none">
                <span class="font-black uppercase text-[11px]">${u}</span>
                <span class="text-pink-500 font-bold text-[9px] mt-1">${d.points ? d.points[u] || 0 : 0} PTS</span></div></div>`
            ).join("");


          } else if (d.status === "showing_order") {
            document.getElementById("screen-game-order").classList.remove("hidden");
            //MOSTRAMOS ORDEN DE TURNOS
            document.getElementById("turn-order-list").innerHTML = d.turnOrder.map((p, i) => 
                `<div class="player-card text-xs"><div class="bg-pink-600 text-white w-6 h-6 rounded-full flex items-center justify-center font-black">${i+1}</div><img src="${getAvatar(d.players[p])}" class="avatar"><span>${p}</span></div>`
            ).join("");

            if (isIHost) document.getElementById("host-start-trigger").classList.remove("hidden");
            } 
            else if (d.status === "started") {
              document.getElementById("screen-game").classList.remove("hidden");
              
              // MOSTRAR EVENTO A TODOS (Admin, Impostor e Inocentes)
              if(d.event === "x2" && !d.eventShowed) {
                  const el = document.getElementById("event-screen");
                  el.classList.add("active");
                  setTimeout(() => el.classList.remove("active"), 3000);
                  // Solo el host marca el evento como mostrado para que no se repita
                  if(isIHost) db.ref(`rooms/${currentRoom}/eventShowed`).set(true);
              }

              if (d.mode === "admin" && isIHost && !d.players[myName]) {
                document.getElementById("admin-view").classList.remove("hidden"); document.getElementById("player-view").classList.add("hidden");
                document.getElementById("admin-word-info").innerText = d.word;
              } else {
                document.getElementById("admin-view").classList.add("hidden"); document.getElementById("player-view").classList.remove("hidden");
                if (d.assignments && d.assignments[myName]) showRole(d.assignments[myName], d.word, d.category);
              }
              if (isIHost) document.getElementById("host-game-controls").classList.remove("hidden");

          } else if (d.status === "voting") {

            document.getElementById("screen-voting").classList.remove("hidden");
            const numLiars = Object.values(d.assignments).filter(r => r === "mentiroso").length;
            
            if (d.players[myName] && !(d.votes && d.votes[myName])) {
                document.getElementById("vote-instruction").innerText = numLiars > 1 ? `Selecciona ${numLiars} mentirosos (${tmpV.length}/${numLiars})` : "Selecciona al mentiroso";
                document.getElementById("vote-list").innerHTML = pKeys.map(u => `
                    <button id="vote-btn-${u}" onclick="castVote('${u}')" class="player-card w-full uppercase font-black text-xs ${tmpV.includes(u) ? 'selected-vote' : ''}">
                        <img src="${getAvatar(d.players[u])}" class="avatar">
                        <span>${u}</span>
                        ${tmpV.includes(u) ? '<span class="ml-auto text-pink-500">‚úÖ</span>' : ''}
                    </button>`).join("");
            } else {
                document.getElementById("vote-instruction").innerText = "Esperando al resto...";
                document.getElementById("vote-list").innerHTML = pKeys.map(u => `<div class="player-card opacity-50 text-xs"><img src="${getAvatar(d.players[u])}" class="avatar"><span>${u}</span>${d.votes && d.votes[u] ? '<span class="ml-auto text-green-500 font-bold">VOT√ì</span>' : ""}</div>`).join("");
            }

            if (d.votes && Object.keys(d.votes).length >= pKeys.length && !d.animShowed) {
              const liars = Object.entries(d.assignments).filter(([p, r]) => r === "mentiroso").map(e => e[0]);
              const counts = {}; Object.values(d.votes).forEach(vL => vL.forEach(v => counts[v] = (counts[v] || 0) + 1));
              const sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]);
              const winners = sorted.filter(e => e[1] === sorted[0][1]);

              if (isIHost) {
                  db.ref(`rooms/${currentRoom}/animShowed`).set(true);
                  const multiplier = (d.event === "x2") ? 2 : 1;
                  if (winners.length === 1) {
                      const target = winners[0][0], targetIsLiar = d.assignments[target] === "mentiroso";
                      Object.entries(d.assignments).forEach(([p, role]) => {
                          if (role === "mentiroso" && target !== p) db.ref(`rooms/${currentRoom}/points/${p}`).transaction(v => (v || 0) + (3 * multiplier));
                          if (role === "inocente" && targetIsLiar && d.votes[p]?.includes(target)) db.ref(`rooms/${currentRoom}/points/${p}`).transaction(v => (v || 0) + (1 * multiplier));
                      });
                  }
              }

              if (winners.length > 1) {
                  const scr = document.getElementById("tie-screen");
                  document.querySelector("#tie-screen .hero-title").innerText = "EMPATE";
                  document.querySelector("#tie-screen .hero-title").style.color = "#fff";
                  document.getElementById("tie-msg").innerText = "Empate de votos: nadie es expulsado";
                  document.getElementById("tie-icon").innerText = "‚öñÔ∏è";
                  scr.classList.add("active");
                  setTimeout(() => { 
                      scr.classList.remove("active"); 
                      if(isIHost) db.ref(`rooms/${currentRoom}`).update({ status: "started", votes: null, animShowed: false }); 
                  }, 4000);                
                } else {
                  const target = winners[0][0], targetIsLiar = d.assignments[target] === "mentiroso";
                  if (targetIsLiar) {
                      const scr = document.getElementById("ejection-screen");
                      document.getElementById("ejection-avatars-flow").innerHTML = liars.map(l => `<div class="floating-avatar"><img src="${getAvatar(d.players[l])}" class="w-full h-full"></div>`).join("");
                      document.getElementById("ejection-msg").innerHTML = `MENTIROSO PILLADO:<br><span class="text-pink-500">${target}</span>`;
                      scr.classList.add("active");
                      setTimeout(() => { scr.classList.remove("active"); showFinalResults(d, pKeys, counts); }, 5000);
                  } else {
                      // VICTORIA DEL IMPOSTOR (Si el m√°s votado era un Inocente)
                      const scr = document.getElementById("tie-screen"); 
                      document.getElementById("tie-msg").innerText = "¬°LOS MENTIROSOS HAN GANADO!";
                      document.querySelector("#tie-screen .hero-title").innerText = "DERROTA";
                      document.getElementById("tie-icon").innerText = "üíÄ";
                      scr.classList.add("active");
                      setTimeout(() => { scr.classList.remove("active"); showFinalResults(d, pKeys, counts); }, 5000);
                  }
              }
          }
          }
        });
      }

      function showFinalResults(d, pKeys, counts) {
        document.getElementById("vote-results").classList.remove("hidden");
        document.getElementById("results-display").innerHTML = pKeys.map(p => {
            const isLi = d.assignments[p] === "mentiroso";
            const numVotos = counts[p] || 0;
            
            // L√ìGICA DE LOGROS
            let badge = "";
            if (isLi && numVotos === 0) badge = "üèÜ MAESTRO DEL ENGA√ëO";
            else if (!isLi && numVotos >= pKeys.length / 2) badge = "ü¶ê GAMBA CONFUNDIDA";
            else if (isLi && numVotos === pKeys.length) badge = "üíÄ PILLADO TOTAL";

            return `<div class="flex flex-col bg-white/5 p-3 rounded-lg text-white mb-2 ${isLi ? "border-l-4 border-pink-600" : ""}">
                <div class="flex justify-between items-center w-full">
                    <div class="flex flex-col">
                        <span class="text-[10px] font-black uppercase">${p}</span>
                        <span class="${isLi ? "text-pink-500" : "text-zinc-500"} text-[8px] font-bold uppercase">${isLi ? "Mentiroso" : "Inocente"}</span>
                    </div>
                    <span class="font-black text-xs">${numVotos} VOTOS</span>
                </div>
                ${badge ? `<div class="text-[7px] mt-1 font-black text-yellow-400 tracking-tighter">${badge}</div>` : ""}
            </div>`;
        }).join("");
        if (d.host === myName) document.getElementById("btn-final-reset").classList.remove("hidden");
      }

      function startGame() {
        db.ref("rooms/" + currentRoom).once("value", (s) => {
          const d = s.val(), pKeys = Object.keys(d.players).filter(k => d.players[k] !== "KICKED");
          db.ref("rooms/" + currentRoom).update({ status: "showing_order", turnOrder: shuffleArray([...pKeys]), animShowed: false });
        });
      }


      
      function confirmStartGame() {
        db.ref("rooms/" + currentRoom).once("value", (s) => {
          const d = s.val(), num = parseInt(document.getElementById("liar-range").value);
          const dictionary = [
              { w: "LE√ìN", c: "ANIMALES" }, { w: "PIZZA", c: "COMIDA" }, { w: "F√öTBOL", c: "DEPORTES" }, { w: "MESA", c: "HOGAR" }, { w: "CINE", c: "OCIO" }, { w: "M√âDICO", c: "PROFESIONES" }
          ];
          
          let item;
          let autorDeLaIdea = null;

          // 1. SELECCI√ìN DE PALABRA Y AUTOR
          if (d.mode === "ideas" && d.ideas) {
              const autores = Object.keys(d.ideas);
              autorDeLaIdea = autores[Math.floor(Math.random() * autores.length)];
              item = d.ideas[autorDeLaIdea];
          } else if (d.mode === "admin" && document.getElementById("admin-manual-word").value) {
              item = {w:document.getElementById("admin-manual-word").value.toUpperCase(), c:"MANUAL"};
          } else {
              item = dictionary[Math.floor(Math.random() * dictionary.length)];
          }
          
          // 2. ASIGNACI√ìN DE ROLES (PROTEGIENDO AL AUTOR)
          let assigns = {};
          const pKeys = d.turnOrder; // Lista de jugadores en la sala
          
          // Filtramos la lista: quitamos al autor para que no entre en el sorteo de impostores
          let candidatosAImpostor = pKeys.filter(p => p !== autorDeLaIdea);
          
          // Mezclamos solo a los que SI pueden ser impostores
          candidatosAImpostor = shuffleArray([...candidatosAImpostor]);
          
          pKeys.forEach(p => {
              if (p === autorDeLaIdea) {
                  // El que mand√≥ la idea es Inocente siempre
                  assigns[p] = "inocente";
              } else {
                  // Buscamos su posici√≥n en la lista de candidatos mezclada
                  const idx = candidatosAImpostor.indexOf(p);
                  assigns[p] = (idx < num) ? "mentiroso" : "inocente";
              }
          });
          
          // 3. EVENTO ALEATORIO X2
          const event = (Math.random() < 0.3) ? "x2" : "none";

          db.ref("rooms/" + currentRoom).update({ 
            status: "started", 
            word: item.w, 
            category: item.c, 
            assignments: assigns, 
            votes: null, 
            animShowed: false,
            event: event,
            eventShowed: false 
          });
        });
      }



      function openVoting() { db.ref(`rooms/${currentRoom}`).update({ status: "voting", votes: null }); }
      
      function castVote(t) {
        db.ref(`rooms/${currentRoom}`).once("value", (s) => {
          const d = s.val(), max = Object.values(d.assignments).filter(r => r === "mentiroso").length;
          if (tmpV.includes(t)) { tmpV = tmpV.filter(v => v !== t); } else if (tmpV.length < max) { tmpV.push(t); }
          if (tmpV.length === max) { db.ref(`rooms/${currentRoom}/votes/${myName}`).set(tmpV); tmpV = []; } else { listenToRoom(currentRoom); }
        });
      }

      function showRole(r, w, c) {
        document.getElementById("role-title").innerText = r === "mentiroso" ? "MENTIROSO" : "INOCENTE";
        document.getElementById("role-title").style.color = r === "mentiroso" ? "#db2777" : "#fff";
        document.getElementById("word-display").innerText = r === "mentiroso" ? "???" : w;
        document.getElementById("hint-text").innerText = (r === "mentiroso" ? "Pista: " +  c : "");
      }

      function resetGame() { 
        db.ref("rooms/" + currentRoom).update({ 
            status: "waiting", 
            assignments: null, 
            turnOrder: null, 
            votes: null, 
            animShowed: false, 
            ideas: null,
            event: "none"
        }); 
      }

      function sendIdea() {
        const w = document.getElementById("idea-word").value.trim().toUpperCase(), c = document.getElementById("idea-cat").value.trim().toUpperCase();
        if (w && c) db.ref(`rooms/${currentRoom}/ideas/${myName}`).set({ w, c });
      }
    </script>
  </body>
</html>
